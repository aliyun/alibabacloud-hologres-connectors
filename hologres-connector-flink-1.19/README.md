mvn clean install -N
## 依赖hologres-connector-flink-base，实现了Flink 1.19版本的Connector

- 支持结果表、维表、批量源表（connector-1.2版本开始支持）

## 准备工作

- 需要**Hologres 1.3**及以上版本, 建议使用2.1及以上版本。
- 需要Flink1.19

### 从中央仓库获取jar

可以在项目pom文件中通过如下方式引入依赖，其中`<classifier>`必须加上，防止发生依赖冲突。

```xml

<dependency>
    <groupId>com.alibaba.hologres</groupId>
    <artifactId>hologres-connector-flink-1.19</artifactId>
    <version>1.6.0</version>
    <classifier>jar-with-dependencies</classifier>
</dependency>
```

### 自行编译

connector依赖父项目的pom文件，在本项目根目录执行以下命令进行install

```
mvn clean install -N
```

#### build base jar 并 install 到本地maven仓库

- -P指定相关版本参数

```
mvn package install -pl hologres-connector-flink-base -DskipTests -Pflink-1.19
```

#### build jar

```
mvn package -pl hologres-connector-flink-1.19 -DskipTests
```

## 使用示例

见 hologres-connector-examples子项目

## Hologres Flink Connector相关参数说明

## WITH参数

### 通用

|  参数  |  说明  |  数据类型  |  是否必填  |  默认值  | 备注                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| --- | --- | --- | --- | --- |------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|  connector  |  表类型。  |  String  |  是  |  无  | 固定值为`hologres`。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|  dbname  |  数据库名称。  |  String  |  是  |  无  | Hologres V2.0版本推出了全新的弹性高可用实例形态，将计算资源分解为不同的计算组（Virtual Warehouse），更好的服务于高可用部署，详情请参见[计算组实例快速入门](https://help.aliyun.com/zh/hologres/user-guide/getting-started-with-virtual-warehouses)。不同的计算组使用相同的Endpoint，您可以通过在dbname参数后添加特定的后缀来指定连接某个计算组。例如某张维表希望连接特定的计算组read\_warehouse，可以通过`'dbname' = 'db_test@read_warehouse'` 方式指定，详情请参见[连接计算组](https://help.aliyun.com/zh/hologres/user-guide/connect-to-a-virtual-warehouse)。                                                                               |
|  tablename  |  表名称。  |  String  |  是  |  无  | 如果Schema不为Public时，则tablename需要填写为`schema.tableName`。                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|  username  |  用户名，请填写阿里云账号的AccessKey ID。  |  String  |  是  |  无  | 详情请参见[如何查看AccessKey ID和AccessKey Secret信息？](https://help.aliyun.com/zh/flink/support/reference#24cde8802a8qe) **重要** 为了避免您的AK信息泄露，建议您通过密钥管理的方式填写AccessKey ID取值，详情请参见[变量管理](https://help.aliyun.com/zh/flink/user-guide/manage-keys)。                                                                                                                                                                                                                                                                 |
|  password  |  密码，请填写阿里云账号的AccessKey Secret。  |  String  |  是  |  无  | 详情请参见[如何查看AccessKey ID和AccessKey Secret信息？](https://help.aliyun.com/zh/flink/support/reference#24cde8802a8qe) **重要** 为了避免您的AK信息泄露，建议您通过密钥管理的方式填写AccessKey Secret取值，详情请参见[变量管理](https://help.aliyun.com/zh/flink/user-guide/manage-keys)。                                                                                                                                                                                                                                                             |
|  endpoint  |  Hologres服务地址。  |  String  |  是  |  无  | 详情请参见[访问域名](https://help.aliyun.com/zh/hologres/user-guide/endpoints-for-connecting-to-hologres#concept-1715026)。                                                                                                                                                                                                                                                                                                                                                                                    |
|  connection.pool.name  |  连接池名称。同一个TaskManager中，配置相同名称的连接池的表可以共享连接池。  |  String  |  否  |  无  | **说明** <p> 此参数可以按需配置，比如作业中有维表A，B以及结果表C，D，E五张hologres表，可以A表和B表使用'pool1'，C表和D表使用'pool2'，E表流量较大，单独使用'pool3'。     <p>  批量源表和COPY模式写入，不受此参数控制，固定为一个task一个连接                                                                                                                                                                                                                                                                                                                                               |
|  connection.pool.size  |  连接池大小  |  Integer  |  否  |  3  | **说明** <p> 不同表配置相同的连接池但connection.pool.size不同时，连接池实际大小取最大值。                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|  connection.fixed  |  是否启用轻量级连接模式  |   |   |   | **说明** <p>   仅对维表点查和INSERT模式结果表生效，使用轻量级连接，不占用Hologres实例的连接数，需要Hologres版本在2.1及以上，目前不支持写入和查询roaringbitmap，jsonb，serial类型。                                                                                                                                                                                                                                                                                                                                                                                |
|  connection.ssl.mode  |  是否启用SSL（Secure Sockets Layer）传输加密，以及启用采用何种模式。  |  String  |  否  |  disable  | 参数取值如下： <p> disable（默认值）：不启用传输加密。      <p> require：启用SSL，只对数据链路加密。      <p>   verify-ca：启用SSL，加密数据链路，同时使用CA证书验证Hologres服务端的真实性。     <p>  verify-full：启用SSL，加密数据链路，使用CA证书验证Hologres服务端的真实性，同时比对证书内的CN或DNS与连接时配置的Hologres连接地址是否一致。      **说明** <p>   Hologres自1.1版本起支持SSL传输加密的require模式，2.1版本起新增支持verify-ca和verify-full模式。详见[传输加密](https://help.aliyun.com/zh/hologres/security-and-compliance/ssl-encrypted-transmission)。      <p>  当配置为verify-ca或者verify-full时，需要同时配置connection.ssl.root-cert.location参数。 |
|  connection.ssl.root-cert.location  |  当传输加密模式需要证书时，配置证书的路径。  |  String  |  否  |  无  | 当connection.ssl.mode配置为verify-ca或者verify-full时，需要同时配置CA证书的路径。证书可以使用实时计算控制台的资源上传功能上传至平台，上传后文件存放在/flink/usrlib目录下。例如，需要使用的CA证书文件名为certificate.crt，则上传后参数取值应该为 `'/flink/usrlib/certificate.crt'`。 **说明** <p>  CA证书获取方式见[传输加密-下载CA证书](https://help.aliyun.com/zh/hologres/security-and-compliance/ssl-encrypted-transmission#0c8bcca0891oq)。                                                                                                                                                              |
|  retry-count  |  当连接故障时，写入和查询的重试次数。  |  Integer  |  否  |  10  | 无。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|  retry-sleep-step-ms  |  每次重试的累加等待时间。  |  Long  |  否  |  5000  | 实际重试的等待时间的计算公式为`retryTime * jdbcRetrySleepStepMs`。单位为毫秒。                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|  connection.max-idle-ms  |  JDBC连接的空闲时间。  |  Long  |  否  |  60000  | 超过这个空闲时间，连接就会断开释放掉。单位为毫秒。                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|  connection.meta-cache-ttl-ms  |  本地缓存TableSchema信息的过期时间。  |  Long  |  否  |  60000  | 单位为毫秒。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |

### 源表独有


|  参数  |  说明  |  数据类型  |  是否必填  |  默认值  |  备注  |
| --- | --- | --- | --- | --- | --- |
|  source.scan.fetch-size  |  扫描时攒批大小。  |  Integer  |  否  |  256  |  无。  |
|  source.scan.timeout-seconds  |  扫描操作超时时间。  |  Integer  |  否  |  28800  |  单位为秒。  |
|  source.filter-push-down.enabled  |  全量读取阶段是否进行filter下推。  |  Boolean  |  否  |  false  |  参数取值如下： <p>false（默认值）：不进行filter下推。      <p>true：读取全量数据时，将支持的过滤条件下推到Hologres执行。包括非Binlog Source全量读取以及Binlog Source使用全增量一体化消费模式时的全量阶段。       |

### 结果表独有

| 参数                                   | 说明                                                            |  数据类型  |  是否必填  |  默认值  | 备注                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|--------------------------------------|---------------------------------------------------------------| --- | --- | --- |----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| sink.write-mode                      | 写入模式                                                          |  Enum  |  否  |  INSERT  | 参数取值如下： <p>INSERT（默认值）：表示使用jdbc生成INSERT语句进行写入。      <p>  COPY\_STREAM：STREAM流式写入，采用COPY协议。流式写入是hologres1.3新增的能力，相比通过insert方法（jdbc模式）进行写入，fixed copy方式可以更高的吞吐（因为是流模式），更低的数据延时，更低的客户端内存消耗（因为不攒批）。      <p>COPY\_BULK\_LOAD：BULK\_LOAD批量写入，采用COPY协议。写入目前仅适用于无主键表，相比默认的jdbc\_copy，写入使用更少的Hologres资源。      <p>COPY\_BULK\_LOAD\_ON\_CONFLICT：BULK\_LOAD批量写入，采用COPY协议，支持写入有主键表，需要和下方`sink.reshuffle-by-holo-distribution-key.enabled`参数结合使用。    <p>  **说明**  <p>COPY协议写入暂不支持delete数据，支持写入分区父表，但不支持自动创建子表。不支持ignoreNullWhenUpdate参数。      <p>  COPY\_BULK\_LOAD写入数据不是实时可见的，在Flink每次做checkpoint时，数据才会落盘可见。      <p>bulkload写入有主键表时,默认是表锁。在上游数据根据shard进行了repartition的基础上,可以开启COPY\_BULK\_LOAD\_ON\_CONFLICT参数,将写入有主键表的锁粒度从表级别调整为shard级别,提高写入性能。 |
| sink.on-conflict-action              | 数据写入主键冲突时的处理策略。                                               |  String  |  否  |  insertorupdate  | 详情请参见[流式语义](https://help.aliyun.com/zh/flink/developer-reference/hologres-connector/?spm=a2c4g.185484.0.0.26ff111dREBKGV#4aa746f12b7lt)。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| sink.insert.batch-size               | INSERT模式，Hologres Sink节点数据攒批条数（不是来一条数据处理一条，而是攒一批再处理）的最大值。     |  Integer  |  否  |  256  | 说明 sink.insert.batch-size、sink.insert.batch-byte-size和sink.insert.flush-interval-ms三者之间为或的关系。如果同时设置了这三个参数，则满足其中一个，就进行写入结果数据。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| sink.insert.batch-byte-size          | INSERT模式，Hologres Sink节点数据攒批字节数（不是来一条数据处理一条，而是攒一批再处理）的最大值。    |  Long  |  否  |  2097152（2\*1024\*1024）字节，即2 MB  | 说明 sink.insert.batch-size、sink.insert.batch-byte-size和sink.insert.flush-interval-ms三者之间为或的关系。如果同时设置了这三个参数，则满足其中一个，就进行写入结果数据。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| sink.insert.flush-interval-ms        | INSERT模式，Hologres Sink节点数据攒批写入Hologres的最长等待时间。                |  Long  |  否  |  10000  | 单位为毫秒。 说明 sink.insert.batch-size、sink.insert.batch-byte-size和sink.insert.flush-interval-ms三者之间为或的关系。如果同时设置了这三个参数，则满足其中一个，就进行写入结果数据。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| sink.ignore-null-when-update.enabled | 当sink.on-conflict-action='insertOrUpdate'时，是否忽略更新写入数据中的Null值。 |  Boolean  |  否  |  false  | 取值说明如下： <p>  false（默认值）：将Null值写到Hologres结果表里。      <p>   true：忽略更新写入数据中的Null值。      说明 <p>   仅 sink.write-mode配置为INSERT时生效。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| sink.create-missing-partition        | 当写入分区表时，是否根据分区值自动创建不存在的分区表。                                   |  Boolean  |  否  |  false  | 说明<p>  仅 sink.write-mode配置为INSERT时生效。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| sink.ignore-delete                   | 是否忽略撤回消息。                                                     |  Boolean  |  否  |  true  | 说明 <p>  仅 sink.write-mode配置为INSERT时生效。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| sink.remove-u0000-in-text.enabled    | 如果写入时字符串类型包含\u0000非法字符，是否允许连接器帮助去除。                           |  Boolean  |  否  |  true  | 参数取值如下： <p>   false：连接器不对数据进行操作，但碰到脏数据时写入可能抛出如下异常，`ERROR: invalid byte sequence for encoding "UTF8": 0x00`      此时需要在源表提前处理脏数据，或者在SQL中定义脏数据处理逻辑。<p>  true：连接器会帮助去除字符串类型中的\u0000，防止写入抛出异常。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| sink.partial-insert.enabled          | 是否只插入INSERT语句中定义的字段。                                          |  Boolean  |  否  |  false  | 参数取值如下： <p>  false（默认值）：无论INSERT语句中声明了哪些字段，都会更新结果表DDL中定义的所有字段，对于未在INSERT语句中声明的字段，会被更新为null。     <p>  true：将INSERT语句中定义的字段下推给连接器，从而可以只对声明的字段进行更新或插入。      说明<p>  此参数仅在sink.on-conflict-action参数配置为InsertOrUpdate时生效。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| sink.deduplication.enabled           | jdbc及jdbc\_fixed模式写入攒批过程中，是否进行去重。                             |  Boolean  |  否  |  true  | 参数取值如下： <p>  true（默认值）：如果一批数据中有主键相同的数据，默认进行去重，只保留最后一条到达的数据。以两个字段，其中第一个字段为主键的数据举例：         <p>   `INSERT (1,'a')`和`INSERT (1,'b')`两条记录先后到达，去重之后只保留后到达的`(1,'b')`写入Hologres结果表中。              <p>   Hologres结果表中已经存在记录`(1,'a')`，此时`DELETE (1,'a')`和`INSERT (1,'b')`两条记录先后到达，只保留后到达的`(1,'b')`写入hologres中，表现为直接更新，而不是先删除再插入。         <p>  false：在攒批过程中不进行去重，如果发现新到的数据和目前攒批的数据中存在主键相同的情况，先将攒批数据写入，写入完成之后再继续写入新到的数据。      说明 <p>   不允许攒批去重时，极端情况下（例如所有数据的主键都相同）写入会退化为不攒批的单条写入，对性能有一定影响。                                                                                                                                                                                                                                                       |
| sink.aggressive.enabled              | 是否启用激进提交模式。                                                   |  Boolean  |  否  |  false  | 设置为true时，即便攒批未达到预期条数，连接在空闲时将会被强制提交。在流量较小时，可以有效减少数据写入的延时。 重要 <p>   仅 sink.write-mode配置为INSERT，COPY\_STREAM时生效。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| sink.check-and-put.column            | 启用条件更新能力，并指定检查的字段名。                                           |  String  |  否  |  无  | 参数取值必须设置为Hologres表存在的字段名。 重要 <p>  仅 sink.write-mode配置为INSERT时生效。             <p>  结果表必须有主键， `sink.on-conflict-action`参数值必须是`Insertorupdate`或者`insertorreplace`。             <p>  由于需要反查，建议结果表创建为行存表或者行列混存表。              <p>   在数据重复较多的情况下，check-and-put操作会退化为单条写入，这将导致写入性能的降低。                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| sink.check-and-put.operator          | 条件更新操作的比较操作符。                                                 |  String  |  否  |  GREATER  | 比较新record的check字段与表中旧值，符合条件判断操作符时进行更新。目前支持配置为GREATER、GREATER\_OR\_EQUAL、EQUAL、NOT\_EQUAL、LESS、LESS\_OR\_EQUAL、IS\_NULL、IS\_NOT\_NULL。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| sink.check-and-put.null-as           | 当条件更新时，如果旧数据为null，则将该null值视为此参数配置的有效值。                        |  String  |  否  |  无  | 由于在PostgreSQL中，任何值与NULL进行比较的结果均为FALSE，因此当表中的原有数据为NULL时，进行更新操作时需要设置一个NULL-AS作为参数，相当于SQL中的COALESCE函数。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| sink.insert.conflict-update-set      | 主键冲突时更新的表达式                                                   |  String  |  否  |  无  | 例如该配置项值为col1=old.col1+excluded.col1,col2=excluded.col2时，表示当主键冲突时将col1的值更新为旧值与新值相加,col2更新为新值。 <p> 等价于insert into tbl values(xxx) on conflict(pk) do update set <conflict-update-set>，可填写holo表达式/函数。 <p> 当此项不填时，默认为更新传入的所有字段为新值。 <p> 该配置项与sink.check-and-put*冲突。 <p> 当更新表达式有状态时，比如col=old.col+excluded.col 结果依赖旧值的状态，为保证failover恢复后的数据正确性，请确保有一个可以作为行版本号的字段，并配置sink.insert.conflict-where为excluded.seq>old.seq，保证数据回放时数据的正确性。                                                                                                                                                                                                                                                                                                            |
| sink.insert.conflict-where           | 主键冲突时触发更新的过滤条件                                                |  String  |  否  |  无  | 例如该配置项值为excluded.col1>old.col1时，表示当主键冲突时,如果col1的新值大于旧值时，才会触发更新。 <p> 等价于insert into tbl values(xxx) on conflict(pk) do update set <conflict-update-set> where <conflict-where>，可填写holo表达式/函数 <p> 该配置项与sink.check-and-put*冲突。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |

### 维表独有

|  参数  |  说明  |  数据类型  |  是否必填  |  默认值  |  备注  |
| --- | --- | --- | --- | --- | --- |
|  lookup.read.batch-size  |  点查Hologres维表时，攒批处理的最大条数。  |  Integer  |  否  |  128  |  无。  |
|  lookup.read.batch-queue-size  |  维表点查请求缓冲队列大小。  |  Integer  |  否  |  256  |  无。  |
|  lookup.read.column-table.enabled  |  维表是列存表需要开启此参数。  |  Boolean  |  否  |  false  |  Hologres Connector默认仅支持对有主键行存表或者行列混存表进行点查，如果维表是列存表会抛出异常。可以显示的指定此参数以使用列存表做维表，但不建议这样操作。  |
|  lookup.cache  |  缓存策略。  |  String  |  否  |  NONE  |  Hologres仅支持NONE和PARTIAL两种缓存策略。  |
|  lookup.partial-cache.max-rows  |  缓存大小。  |  Integer  |  否  |  10000  |  查找缓存的最大行数，超过这个值，最旧的行将过期。使用该配置时 "lookup.cache" 必须设置为 "PARTIAL”。  |
|  lookup.partial-cache.expire-after-write  |  在记录写入缓存后该记录的最大保留时间  |  Duration  |  否  |  无  |  在记录写入缓存后该记录的最大保留时间，例如`'10000s'`。 使用该配置时 "lookup.cache" 必须设置为 "PARTIAL”。  |
|  lookup.partial-cache.expire-after-access  |  在缓存中的记录被访问后该记录的最大保留时间  |  Duration  |  否  |  无  |  在缓存中的记录被访问后该记录的最大保留时间，例如`'10000s'`。 使用该配置时 "lookup.cache" 必须设置为 "PARTIAL”。  |
|  lookup.partial-cache.cache-missing-key  |  是否缓存join结果为空的数据。  |  Boolean  |  否  |  true  |  <p>  true（默认值）：缓存join结果为空的数据。     <p>  false：不缓存join结果为空的数据。      但当join语句中AND前面条件符合而后面条件不符合时，依然会缓存join结果为空的数据。代码示例如下。 ```sql LEFT JOIN latest_emergency FOR SYSTEM_TIME AS OF PROCTIME() AS t2  ON t1.alarm_id = t2.alarm_id -- 如果发现是动态告警，则匹配时加入动态告警id，否则无需考虑动态告警id字段。  AND CASE  WHEN alarm_type = 2 THEN t1.dynamic_id = t2.dynamic_alarm_id  ELSE true  END ```  |
|  lookup.async  |  是否异步返回数据。  |  Boolean  |  否  |  false  |  <p>  true：表示异步返回数据。      <p>  false（默认值）：表示不进行异步返回数据。      **说明** 异步返回数据是无序的。  |

## 类型映射

Flink与Hologres的数据类型映射请参见[Blink/Flink与Hologres的数据类型映射](https://help.aliyun.com/zh/hologres/developer-reference/data-types#section-x29-ngb-txf)。


